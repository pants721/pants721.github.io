<!DOCTYPE html>
<html lang="en-us"
  dir="ltr">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="http://localhost:1313//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="http://localhost:1313//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:1313//apple-touch-icon.png">

<meta name="description" content=""/>



<title>
    
    My old code sucks | nukem.dev
    
</title>

<link rel="canonical" href="http://localhost:1313/posts/skely-2/"/>

<meta property="og:url" content="http://localhost:1313/posts/skely-2/">
  <meta property="og:site_name" content="nukem.dev">
  <meta property="og:title" content="My old code sucks">
  <meta property="og:description" content="Hi everyone! For the past week or so I’ve been revisiting an old project of mine called Skely, which is a tool I wrote to help use and manage project templates (a.k.a. skeletons). The last time I touched the project was right over a year ago, around when I first started learning rust, so the code quality was not great. Since then, I’ve become an much much better developer and I want to look at some of my old code, look at the new code, and analyze why the new code is better.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-11T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-03-11T00:00:00+00:00">
    <meta property="article:tag" content="Development">
    <meta property="article:tag" content="Rust">
    <meta property="article:tag" content="Skely">













<link rel="stylesheet" href="/assets/combined.min.42300404f9778370b77e340b9825b02021f72c5079dafcc6ab01a8456d04bef1.css" media="all">





</head>







<body class="auto">

  <div class="content">
    <header>
      

<div class="header">

    

    <h1 class="header-title">
        <a href="http://localhost:1313/">nukem.dev</a>
    </h1>

    <div class="flex">
        

        
        
      
        <p class="small ">
            <a href="/" >
                /home
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/posts" >
                /posts
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/projects" >
                /projects
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/contact" >
                /contact
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/about" >
                /about
            </a>
        </p>
        
        
    </div>

    

</div>

    </header>

    <main class="main">
      





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> / </span>
    
    <a href="/posts/">Posts</a>
    <span class="breadcrumbs-separator"> / </span>
    
    <a href="/posts/skely-2/">My old code sucks</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">My old code sucks</h1>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2024-03-11T00:00:00&#43;00:00">March 11, 2024</time>
      

      
    </p>

  </div>

  

  

  

  

  <div class="single-content">
    <p>Hi everyone! For the past week or so I&rsquo;ve been revisiting an old project of
mine called <a href="https://github.com/pants721/skely">Skely</a>, which is a tool I wrote
to help use and manage project templates (a.k.a. skeletons). The last time I
touched the project was right over a year ago, around when I first started
learning rust, so the code quality was not great. Since then, I&rsquo;ve become an
much much better developer and I want to look at some of my old code, look at
the new code, and analyze why the new code is better. This won&rsquo;t be a complete
code review, so if you&rsquo;re interested in the project&rsquo;s development make sure to
check it out on <a href="https://github.com/pants721/skely">Github</a>!</p>
<p>The major issue with the 1.0 was over-engineering. On paper, Skely should be a
pretty simple project. It only has 3 jobs:</p>
<ol>
<li>Copy files to its <code>skeletons</code> directory</li>
<li>Copy files from its <code>skeletons</code> directory</li>
<li>Find and replace the placeholder phrase throughout the project</li>
</ol>
<p>However, Skely 1.0 drastically overachieved (or attempted to), which was the
root of the design issues. It defined its own <code>.sk</code> file format for single file
skeletons, which was utterly pointless as no kind of meta-data akin to markdown
front-matter was stored in the file what so ever. The <code>$ sk new</code> command had a
<code>--touch</code> boolean flag which just created a <code>.sk</code> file of that name in the
<code>skeletons</code> directory- again, utterly pointless.</p>
<p>Skely 1.0 also included the <code>edit</code> command. I think that this feature, although
unnecessary and now removed, is something that I&rsquo;m going to consider adding
again. The main problem is that I was a noob and didn&rsquo;t know about environment
variables. On most UNIX systems the <code>$EDITOR</code> and <code>$VISUAL</code> variables are set,
usually to nano or vi by default. I didn&rsquo;t know this at the time being a
beginner and a VSCode/Emacs Mac user, so I created this monstrosity:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rs" data-lang="rs"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">pub</span> <span style="font-weight:bold;text-decoration:underline">fn</span> <span style="color:#666;font-weight:bold;font-style:italic">open_editor</span>(arg: <span style="font-weight:bold;text-decoration:underline">&amp;</span><span style="color:#666;font-weight:bold;font-style:italic">PathBuf</span>, editor_opt: <span style="font-weight:bold;text-decoration:underline">&amp;</span><span style="font-weight:bold;font-style:italic">Option</span>&lt;<span style="font-weight:bold;font-style:italic">String</span>&gt;) -&gt; <span style="font-weight:bold;font-style:italic">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">match</span> editor_opt {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold;font-style:italic">Some</span>(editor) =&gt; { ... }
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold;font-style:italic">None</span> =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#888;font-weight:bold">#[rustfmt::skip]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#888;font-style:italic">// Editors (in order)
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>            <span style="font-weight:bold;font-style:italic;text-decoration:underline">let</span> editors = vec![
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;nvim&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;hx&#34;</span>, <span style="color:#888;font-style:italic">// helix
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>                <span style="color:#666;font-style:italic">&#34;vim&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;micro&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;nano&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;emacs&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;vi&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;pico&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;amp&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#666;font-style:italic">&#34;ne&#34;</span>, <span style="color:#888;font-style:italic">// nice editor :)
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>            ];
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold;text-decoration:underline">for</span> editor <span style="font-weight:bold;text-decoration:underline">in</span> editors {
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold;font-style:italic;text-decoration:underline">let</span> output = Command::new(<span style="color:#666;font-style:italic">&#34;which&#34;</span>)
</span></span><span style="display:flex;"><span>                    .arg(editor)
</span></span><span style="display:flex;"><span>                    .output()
</span></span><span style="display:flex;"><span>                    .context(<span style="color:#666;font-style:italic">&#34;Failed to execute command&#34;</span>)?;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>                <span style="font-weight:bold;text-decoration:underline">if</span> output.status.success() {
</span></span><span style="display:flex;"><span>                    Command::new(editor)
</span></span><span style="display:flex;"><span>                        .arg(arg)
</span></span><span style="display:flex;"><span>                        .spawn()?
</span></span><span style="display:flex;"><span>                        .wait()?;
</span></span><span style="display:flex;"><span>                    <span style="font-weight:bold;text-decoration:underline">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;font-style:italic">Ok</span>(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Oh no&hellip; I hard coded default editors. This design decision is just insane
looking back. To explain the code, when using <code>$ sk edit</code>, if an editor wasn&rsquo;t
specified in Skely&rsquo;s <code>config.toml</code> file, then Skely would iterate over this
hard coded list of editors in order and find the first one where the <code>$ which  &lt;EDITOR&gt;</code> command succeeded.</p>
<p>If you haven&rsquo;t realized already, this is an INSANE way to do this. First of
all, what happens if none of these editors are installed? Is the command just
non-functional then? Second, why is this the order? Most users aren&rsquo;t going to
read the configuration docs, so what if a Emacs user has Neovim installed on
their system? Are they just going to assume Skely is only compatible with
Neovim? Third, you have to edit a file if you want to change what editor you&rsquo;re
using? Now, this one is slightly less egregious as world-renowned tools like
git store preferred editor in a config file as well. However, git also supports
environment variables so that the editor for git operations can be changed
quickly on the fly.</p>
<p>So how would/will this be implemented better? The reason I wrote this
horrendous code is because I didn&rsquo;t know how to fallback from an editor not
being specified in the config file, but now I do: environment variables. The
solution would be to find a user&rsquo;s preferred editor in this order:</p>
<ol>
<li>Check <code>~/$XDG_CONFIG_HOME/sk/config.toml</code></li>
<li>Use <code>$SK_EDITOR</code> environment variable</li>
<li>Use <code>$EDITOR</code> environment variable</li>
<li>Use <code>$VISUAL</code> environment variable</li>
<li>vi</li>
<li>How are you even using a computer if none of those work</li>
</ol>
<p>At my current skill level, this would be the best way to find an editor. The
implementation would look something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rs" data-lang="rs"><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">fn</span> <span style="color:#666;font-weight:bold;font-style:italic">get_editor</span>(&amp;<span style="font-weight:bold;font-style:italic">self</span>) -&gt; <span style="font-weight:bold;font-style:italic">Result</span>&lt;<span style="font-weight:bold;font-style:italic">String</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#888;font-style:italic">// Redundant, but this is just an example
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>    <span style="font-weight:bold;text-decoration:underline">if</span> <span style="font-weight:bold;font-style:italic;text-decoration:underline">let</span> <span style="font-weight:bold;font-style:italic">Ok</span>(editor) = <span style="font-weight:bold;font-style:italic">self</span>.settings.editor {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold;text-decoration:underline">return</span> editor
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">if</span> <span style="font-weight:bold;font-style:italic;text-decoration:underline">let</span> <span style="font-weight:bold;font-style:italic">Ok</span>(editor) = env::var(<span style="color:#666;font-style:italic">&#34;SK_EDITOR&#34;</span>) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold;text-decoration:underline">return</span> editor;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">if</span> <span style="font-weight:bold;font-style:italic;text-decoration:underline">let</span> <span style="font-weight:bold;font-style:italic">Ok</span>(editor) = env::var(<span style="color:#666;font-style:italic">&#34;EDITOR&#34;</span>) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold;text-decoration:underline">return</span> editor;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">if</span> <span style="font-weight:bold;font-style:italic;text-decoration:underline">let</span> <span style="font-weight:bold;font-style:italic">Ok</span>(editor) = env::var(<span style="color:#666;font-style:italic">&#34;VISUAL&#34;</span>) {
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold;text-decoration:underline">return</span> editor;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#666;font-style:italic">&#34;vi&#34;</span>.into()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, let&rsquo;s talk about project structure. Skely 1.0 had way too many files for
how simple of a project it was. The original file tree looked like this:</p>
<pre tabindex="0"><code>src
├── app.rs
├── cli.rs
├── common.rs
├── main.rs
├── settings.rs
└── skeleton.rs
</code></pre><p>This is wayyyy too many files for such a simple project. In any language, the
purpose of having multiple source files is to split up code logically, to allow
for visibility of code to specified as public or private, and to be able
extract, reuse, and reference pieces of code. So if Skely were a large growing
project that needed lots of scalability, this organization would make sense
(except for <code>common.rs</code>, but we&rsquo;ll get to that). The problem goes back to
over-engineering. Skely doesn&rsquo;t do a lot, so this level of abstraction,
although not criminal, doesn&rsquo;t make lots of sense to me. For example, let&rsquo;s
look at <code>settings.rs</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rs" data-lang="rs"><span style="display:flex;"><span><span style="color:#888;font-style:italic">// settings.rs
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span> 
</span></span><span style="display:flex;"><span><span style="color:#888;font-weight:bold">#[derive(Serialize, Deserialize, Debug)]</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">pub</span> <span style="font-weight:bold;text-decoration:underline">struct</span> <span style="color:#666;font-weight:bold;font-style:italic">Settings</span> {
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">pub</span> editor: <span style="font-weight:bold;font-style:italic">Option</span>&lt;<span style="font-weight:bold;font-style:italic">String</span>&gt;,
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold;text-decoration:underline">pub</span> placeholder: <span style="font-weight:bold;font-style:italic">Option</span>&lt;<span style="font-weight:bold;font-style:italic">String</span>&gt;,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="font-weight:bold;text-decoration:underline">impl</span> Settings {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This struct stores a preferred editor and a placeholder phrase. Although I&rsquo;ve
since removed this struct from the source code, it&rsquo;s functionality makes sense,
especially in the context of serializing and deserializing with
<a href="https://serde.rs/">serde</a>. But when would this ever be used outside of the
<code>App</code> struct that stores the central data for Skely? One could argue that you
might pass it into a helper function as a type, but I would argue that a helper
function that needs this should either be implemented for <code>App</code> or should
accept the values of the settings it needs to know about. So because this code
has no real use outside of the <code>App</code> struct, why not store it in <code>app.rs</code>? In a
project where there are multiple variations of settings for different purposes,
or if Skely implemented per-project settings, extracting <code>Settings</code> would make
sense again. For the former, I&rsquo;d go with a trait of some sort, and for the
latter I&rsquo;d use the same struct. As of now, Skely doesn&rsquo;t use a config file and
instead relies on the <code>$SK_PLACEHOLDER</code> environment variable and doesn&rsquo;t have
an edit feature.</p>
<p>Another funny part of Skely 1.0 is the existence of a <code>common.rs</code> file. If I
remember correctly, I used this just because I had seen it as a convention in
smaller C projects, but looking back now it was just lazy coding. During my
initial attempts to refactor the project last week I separated it into
<code>cli_util.rs</code> and <code>file_util.rs</code> respectively. In Skely 2.0, I&rsquo;ve just
flattened it into one <code>util.rs</code> file that contains basic file manipulation
utilities, which I think is fine as they aren&rsquo;t completely miscellaneous and
all take non-Skely data and return non-Skely data.</p>
<p>There are many other issues with Skely 1.0, but this post is getting slightly
long-winded and preachy, especially for a young, learning, and growing
developer like myself. I think that it&rsquo;s very good to be able to go over my old
code and talk about what I did poorly and what I&rsquo;ve learned from it. I also
have no doubt that I will be writing another post like this about code I&rsquo;m
writing now in a year or two. But that&rsquo;s okay, because growing is okay and
mistakes are okay.</p>
<p>Same as your code, you are also a growing and ever-improving project. I hope
you keep that in mind. Give yourself some grace; let yourself breathe.</p>
<p>-Lucas</p>

    
  </div>

  

  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/posts/pilot/">
                        Pilot
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/posts/la-haine/">
                        La Haine - &#34;Jusqu&#39;ici tout va bien&#34;
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


    </main>
  </div>

  <footer>
    

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    


  </footer>

  

</body>

<script src="/js/theme-switch.js"></script>
<script defer src="/js/copy-code.js"></script>
</html>
